name: Deploy RPA to Azure Container App

on:
  push:
    branches:
      - 'release/health-backend-v*'

env:
  NODE_OPTIONS: '--max-old-space-size=6144 --max-semi-space-size=128'

jobs:
  deploy-to-azure:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    env:
      WEBAPP_NAME: 'app-itraffic-rpa'
      NODE_VERSION: '22'
      PNPM_VERSION: '10.17.1'
      ACR_NAME: 'acritrafficrpa2'
      RESOURCE_GROUP: 'rg-itraffic-rpa'
      IMAGE_NAME: 'itraffic-rpa'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Azure Login with OIDC
        uses: azure/login@v1
        with:
          client-id: '94106b64-039f-47ef-9be8-5c19768fda17'
          tenant-id: 'c556f158-baa4-43a2-8dc7-a1619672abff'
          subscription-id: '1bac4488-7f06-44b9-8651-c16aca0f47b8'

      - name: Login to Azure Container Registry
        run: |
          echo "Logging in to Azure Container Registry..."

          # Obtener el login server real del ACR
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer -o tsv)
          echo "ACR Login Server: ${ACR_LOGIN_SERVER}"
          echo "ACR_LOGIN_SERVER=${ACR_LOGIN_SERVER}" >> $GITHUB_ENV

          az acr login --name ${{ env.ACR_NAME }}
          echo "‚úÖ Successfully logged in to ACR"

      - name: Build Docker image
        run: |
          echo "Building Docker image..."

          # Construir tag de imagen basado en commit SHA usando el login server real
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_NAME="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest"

          echo "Image name: ${IMAGE_NAME}"
          echo "Image latest: ${IMAGE_LATEST}"

          # Construir imagen Docker desde la ra√≠z del monorepo
          # El Dockerfile est√° en apps/bip/monolith-backend pero necesita contexto del monorepo
          docker build \
            -f apps/bip/monolith-backend/Dockerfile \
            -t ${IMAGE_NAME} \
            -t ${IMAGE_LATEST} \
            .

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_LATEST=${IMAGE_LATEST}" >> $GITHUB_ENV
          echo "‚úÖ Docker image built successfully"

      - name: Push Docker image to ACR
        run: |
          echo "Pushing Docker image to Azure Container Registry..."
          docker push ${{ env.IMAGE_NAME }}
          docker push ${{ env.IMAGE_LATEST }}
          echo "‚úÖ Docker image pushed successfully"

      - name: Configure Azure App Service for Container
        run: |
          echo "Configuring Azure App Service for Container deployment..."

          # Verificar que el admin user est√© habilitado en ACR
          ADMIN_ENABLED=$(az acr show --name ${{ env.ACR_NAME }} --query adminUserEnabled -o tsv)
          if [ "$ADMIN_ENABLED" != "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Admin user is not enabled in ACR"
            echo "   Enabling admin user now..."
            az acr update --name ${{ env.ACR_NAME }} --admin-enabled true
            echo "‚úÖ Admin user enabled"
          fi

          # Obtener credenciales de ACR para App Service
          ACR_USERNAME=$(az acr credential show --name ${{ env.ACR_NAME }} --query username -o tsv)
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query passwords[0].value -o tsv)

          # Obtener el login server real del ACR
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer -o tsv)
          echo "ACR Login Server: ${ACR_LOGIN_SERVER}"

          # Configurar App Service para usar Container con credenciales de ACR
          az webapp config container set \
            --name ${{ env.WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --docker-custom-image-name ${{ env.IMAGE_NAME }} \
            --docker-registry-server-url https://${ACR_LOGIN_SERVER} \
            --docker-registry-server-user $ACR_USERNAME \
            --docker-registry-server-password $ACR_PASSWORD

          # Configurar variables de entorno
          az webapp config appsettings set \
            --name ${{ env.WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings \
              NODE_ENV=staging \
              PORT=8080 \
              WEBSITES_PORT=8080

          echo "‚úÖ App Service configured for Container"

      - name: Deploy to Azure Web App
        id: deploy
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ env.WEBAPP_NAME }}
          images: ${{ env.IMAGE_NAME }}

      - name: Wait for deployment to stabilize
        run: |
          echo "Waiting 45 seconds for deployment to stabilize..."
          sleep 45

      - name: Fetch application logs
        run: |
          echo "Fetching application logs from Azure..."
          echo "========================================"

          # Obtener los √∫ltimos logs de la aplicaci√≥n
          az webapp log tail \
            --name ${{ env.WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --only-show-errors \
            & LOG_PID=$!

          # Esperar 30 segundos para capturar logs
          sleep 30

          # Matar el proceso de logs
          kill $LOG_PID 2>/dev/null || true

          echo "========================================"
          echo "Log capture complete"

      - name: Set deployment URL from deploy output
        id: get-url
        run: |
          # Usar la URL del output del deploy action
          WEBAPP_URL="${{ steps.deploy.outputs.webapp-url }}"
          echo "url=$WEBAPP_URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $WEBAPP_URL"

      - name: Verify deployment
        continue-on-error: true
        id: health-check
        run: |
          echo "Verifying deployment..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          BASE_URL="${{ steps.get-url.outputs.url }}"
          HEALTH_URL="${BASE_URL}/v1/health"

          echo "Testing health endpoint: $HEALTH_URL"

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES"
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Deployment successful!"
              echo "Health check response:"
              curl -s "$HEALTH_URL"
              exit 0
            fi

            echo "HTTP Code: $HTTP_CODE - Retrying in 10 seconds..."
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done

          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          echo "Testing root endpoint as fallback..."
          curl -v "$BASE_URL/" || true

          echo ""
          echo "‚ö†Ô∏è  Deployment completed but health check failed"
          echo "This might be a temporary issue. Please check Azure logs manually."
          exit 1

      - name: Show deployment result
        if: always()
        run: |
          echo "========================================"
          if [ "${{ steps.health-check.outcome }}" = "success" ]; then
            echo "üöÄ Deployment Successful!"
            echo "Status: ‚úÖ HEALTHY"
          else
            echo "‚ö†Ô∏è  Deployment Completed with Warnings"
            echo "Status: ‚ö†Ô∏è  NEEDS VERIFICATION"
            echo ""
            echo "The application was deployed but health check failed."
            echo "This might mean:"
            echo "  1. The app is still starting up (wait a bit longer)"
            echo "  2. There's an error in the application code"
            echo "  3. Environment variables are missing or incorrect"
            echo "  4. Dependencies failed to install"
            echo ""
            echo "üëâ NEXT STEPS:"
            echo "  1. Check Azure Portal ‚Üí Log Stream for errors"
            echo "  2. Verify environment variables in Configuration"
            echo "  3. Try accessing the URL directly in a few minutes"
            echo "  4. Check if node_modules were installed correctly"
          fi
          echo "========================================"
          echo "App Name: ${{ env.WEBAPP_NAME }}"
          echo "Environment: STAGING"
          echo "URL: ${{ steps.get-url.outputs.url }}"
          echo "Health Check: ${{ steps.get-url.outputs.url }}/v1/health"
          echo "Commit: ${{ github.sha }}"
          echo "========================================"

      - name: Show deployment summary
        if: steps.health-check.outcome == 'success'
        run: |
          echo "================================================"
          echo "üöÄ Staging Deployment Successful!"
          echo "================================================"
          echo "App Name: ${{ env.WEBAPP_NAME }}"
          echo "Environment: STAGING"
          echo "Branch: ${{ github.ref_name }}"
          echo "URL: ${{ steps.get-url.outputs.url }}"
          echo "Health Check: ${{ steps.get-url.outputs.url }}/v1/health"
          echo "API Docs (dev only): ${{ steps.get-url.outputs.url }}/api/docs"
          echo "Commit: ${{ github.sha }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "================================================"
          echo ""
          echo "‚öôÔ∏è  Azure Configuration:"
          echo "   Deployment: Linux Container"
          echo "   Image: ${{ env.IMAGE_NAME }}"
          echo "   Registry: ${{ env.ACR_NAME }}.azurecr.io"
          echo "   Command: node dist/main.js"
          echo ""
          echo "üìù Available Endpoints:"
          echo "   GET  /              - Welcome message"
          echo "   GET  /v1/health        - Health check"
          echo "   POST /v1/auth/login - Authentication"
          echo "   For full API docs, check /api/docs (dev environment only)"
          echo ""
          echo "üìù Next steps:"
          echo "1. Test thoroughly in staging environment"
          echo "2. If ready for production, create and push tag:"
          echo "   TAG_NAME=\$(echo ${{ github.ref_name }} | sed 's/release\///')"
          echo "   git tag \$TAG_NAME"
          echo "   git push origin \$TAG_NAME"
          echo "================================================"

      - name: Show troubleshooting guide
        if: steps.health-check.outcome != 'success'
        run: |
          echo "================================================"
          echo "üîç TROUBLESHOOTING GUIDE"
          echo "================================================"
          echo ""
          echo "The deployment completed but the health check failed."
          echo "Here's how to diagnose the issue:"
          echo ""
          echo "1Ô∏è‚É£  CHECK AZURE LOGS"
          echo "   ‚Üí Azure Portal ‚Üí health-bridge-staging"
          echo "   ‚Üí Monitoring ‚Üí Log Stream"
          echo "   ‚Üí Look for startup errors or crashes"
          echo ""
          echo "2Ô∏è‚É£  VERIFY APP IS RUNNING"
          echo "   ‚Üí Azure Portal ‚Üí Overview"
          echo "   ‚Üí Check if app status is 'Running'"
          echo "   ‚Üí Restart if needed"
          echo ""
          echo "3Ô∏è‚É£  CHECK CONSOLE ACCESS"
          echo "   ‚Üí Azure Portal ‚Üí Development Tools ‚Üí Console"
          echo "   ‚Üí Run: ls -la"
          echo "   ‚Üí Run: cat startup.sh"
          echo "   ‚Üí Run: node dist/main.js (to see errors)"
          echo ""
          echo "4Ô∏è‚É£  VERIFY ENVIRONMENT VARIABLES"
          echo "   ‚Üí Azure Portal ‚Üí Configuration ‚Üí Application Settings"
          echo "   ‚Üí Ensure NODE_ENV=staging exists"
          echo "   ‚Üí Ensure PORT is not set (Azure sets it automatically)"
          echo ""
          echo "5Ô∏è‚É£  TEST ENDPOINTS MANUALLY"
          echo "   Wait 2-3 minutes and try:"
          echo "   curl ${{ steps.get-url.outputs.url }}/v1/health"
          echo ""
          echo "6Ô∏è‚É£  CHECK DEPENDENCIES"
          echo "   In Azure Console:"
          echo "   ‚Üí ls -la node_modules/"
          echo "   ‚Üí npm list --depth=0"
          echo ""
          echo "================================================"
          echo "üìß If issues persist, check the logs above for:"
          echo "   - Missing dependencies"
          echo "   - Permission errors"
          echo "   - Port binding errors"
          echo "   - Environment variable errors"
          echo "================================================"
