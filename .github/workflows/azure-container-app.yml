name: Deploy RPA to Azure Container App

on:
  push:
    branches:
      - 'release/rpa-backend-v*'

env:
  NODE_OPTIONS: '--max-old-space-size=6144 --max-semi-space-size=128'

jobs:
  deploy-to-azure:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    environment: Add-In-RPA
    env:
      PNPM_VERSION: ${{ secrets.PNPM_VERSION }}
      NODE_VERSION: ${{ secrets.NODE_VERSION }}
      WEBAPP_NAME: ${{ secrets.WEBAPP_NAME }}
      ACR_NAME: ${{ secrets.ACR_NAME }}
      RESOURCE_GROUP: ${{ secrets.RESOURCE_GROUP }}
      IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Azure Login with OIDC
        uses: azure/login@v1
        with:
          client-id: '94106b64-039f-47ef-9be8-5c19768fda17'
          tenant-id: 'c556f158-baa4-43a2-8dc7-a1619672abff'
          subscription-id: '1bac4488-7f06-44b9-8651-c16aca0f47b8'

      - name: Login to Azure Container Registry
        run: |
          echo "Logging in to ACR..."
          ACR_LOGIN_SERVER=$(az acr show --name ${{ env.ACR_NAME }} --query loginServer -o tsv)
          echo "ACR_LOGIN_SERVER=${ACR_LOGIN_SERVER}" >> $GITHUB_ENV
          az acr login --name ${{ env.ACR_NAME }}
          echo "✅ Logged in to ACR"

      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          IMAGE_NAME="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          IMAGE_LATEST="${{ env.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest"

          echo "Building Docker image..."
          docker build -f Dockerfile -t ${IMAGE_NAME} -t ${IMAGE_LATEST} .
          docker push ${IMAGE_NAME}
          docker push ${IMAGE_LATEST}

          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "IMAGE_LATEST=${IMAGE_LATEST}" >> $GITHUB_ENV
          echo "✅ Docker image built and pushed"

      - name: Deploy to Azure Container App
        run: |
          echo "Deploying to Container App..."
          az containerapp update \
            --name ${{ env.WEBAPP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.IMAGE_NAME }} \
            --revision-suffix force-pull-$(date +%s) \
            --set-env-vars \
                AZURE_OPENAI_API_KEY="${{ secrets.AZURE_OPENAI_API_KEY }}" \
                PORT="3000" \
                REDIRECT_URI="${{ secrets.REDIRECT_URI }}" \
                AZURE_SEARCH_ENDPOINT="${{ secrets.AZURE_SEARCH_ENDPOINT }}" \
                AZURE_SEARCH_INDEX="${{ secrets.AZURE_SEARCH_INDEX }}" \
                HEADLESS="${{ secrets.HEADLESS }}" \
                ITRAFFIC_HOME_URL="${{ secrets.ITRAFFIC_HOME_URL }}" \
                ITRAFFIC_LOGIN_URL="${{ secrets.ITRAFFIC_LOGIN_URL }}" \
                ITRAFFIC_USER="${{ secrets.ITRAFFIC_USER }}" \
                ITRAFFIC_PASSWORD="${{ secrets.ITRAFFIC_PASSWORD }}" \
                NODE_ENV="${{ secrets.NODE_ENV }}" \
                AZURE_CLIENT_ID="${{ secrets.AZURE_CLIENT_ID }}" \
                AZURE_TENANT_ID="${{ secrets.AZURE_TENANT_ID }}" \
                AZURE_CLIENT_SECRET="${{ secrets.AZURE_CLIENT_SECRET }}" \
                AZURE_OPENAI_DEPLOYMENT="${{ secrets.AZURE_OPENAI_DEPLOYMENT }}" \
                AZURE_OPENAI_ENDPOINT="${{ secrets.AZURE_OPENAI_ENDPOINT }}" \
                COSMOS_DB_ENDPOINT="${{ secrets.COSMOS_DB_ENDPOINT }}" \
                COSMOS_DB_DATABASE_ID="${{ secrets.COSMOS_DB_DATABASE_ID }}" \
                COSMOS_DB_KEY="${{ secrets.COSMOS_DB_KEY }}"
                echo "✅ Container App updated"

      - name: Fetch Container App logs
        run: |
          echo "Fetching logs..."
          az containerapp logs show --name ${{ env.WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --follow &
          LOG_PID=$!
          sleep 30
          kill $LOG_PID 2>/dev/null || true
          echo "✅ Logs fetched"

      - name: Set deployment URL
        id: get-url
        run: |
          URL=$(az containerapp show --name ${{ env.WEBAPP_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} --query properties.configuration.ingress.fqdn -o tsv)
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $URL"

      - name: Verify deployment
        continue-on-error: true
        id: health-check
        run: |
          echo "Verifying deployment..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          BASE_URL="${{ steps.get-url.outputs.url }}"
          HEALTH_URL="https://${BASE_URL}/api/rpa/health"

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Deployment successful"
              curl -s "$HEALTH_URL"
              exit 0
            fi
            echo "HTTP Code: $HTTP_CODE - retrying..."
            sleep 10
            RETRY_COUNT=$((RETRY_COUNT + 1))
          done
          echo "❌ Health check failed after $MAX_RETRIES attempts"
          exit 1
